<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SikaTrack ‚Äì Money Made Simple</title>
  <meta name="theme-color" content="#c8501a"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="SikaTrack"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
/* ============================================================
   SikaTrack v2 ‚Äî Warm Afrocentric ¬∑ Playfair Display + Outfit
   ============================================================ */

:root {
  --bg:        #fdf6ed;
  --bg2:       #f5ead8;
  --surface:   #ffffff;
  --surface2:  #fdf0e2;
  --surface3:  #f9e8d0;
  --text:      #2a1a0a;
  --text2:     #8a6040;
  --text3:     #c09070;
  --accent:    #c8501a;
  --accent2:   #e89a20;
  --green:     #1e7a45;
  --green-bg:  #e6f5ec;
  --red:       #b02020;
  --red-bg:    #fdeaea;
  --border:    #e8d0b0;
  --border2:   #d8c0a0;
  --shadow:    rgba(80,30,5,0.10);
  --shadow2:   rgba(80,30,5,0.20);
  --blue:      #1a6ab0;
  --blue-bg:   #e6f0fa;
}
[data-theme="dark"] {
  --bg:        #150e08;
  --bg2:       #1e1208;
  --surface:   #261808;
  --surface2:  #301e0a;
  --surface3:  #3a2610;
  --text:      #f5e8d0;
  --text2:     #c09060;
  --text3:     #907040;
  --border:    #50300c;
  --border2:   #6a4018;
  --shadow:    rgba(0,0,0,0.50);
  --shadow2:   rgba(0,0,0,0.70);
  --green-bg:  #0a2018;
  --red-bg:    #280808;
  --blue-bg:   #081828;
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  transition: background 0.4s, color 0.4s;
  overflow-x: hidden;
}
body::before {
  content:'';
  position:fixed; inset:0; z-index:0;
  background-image:
    radial-gradient(ellipse at 15% 15%, rgba(200,80,26,0.07) 0%, transparent 50%),
    radial-gradient(ellipse at 85% 85%, rgba(232,154,32,0.07) 0%, transparent 50%),
    repeating-linear-gradient(0deg,   transparent, transparent 60px, rgba(200,80,26,0.02) 60px, rgba(200,80,26,0.02) 61px),
    repeating-linear-gradient(90deg,  transparent, transparent 60px, rgba(200,80,26,0.02) 60px, rgba(200,80,26,0.02) 61px);
  pointer-events:none;
}

@keyframes popIn  { from{transform:scale(.80) translateY(20px);opacity:0} to{transform:scale(1) translateY(0);opacity:1} }
@keyframes slideUp{ from{transform:translateY(20px);opacity:0}             to{transform:translateY(0);opacity:1} }

/* ‚îÄ‚îÄ PIN OVERLAY ‚îÄ‚îÄ */
#pinOverlay { display:none; position:fixed; inset:0; z-index:9999; background:rgba(10,5,2,0.93); backdrop-filter:blur(8px); justify-content:center; align-items:center; }
#pinOverlay.show { display:flex; }
.pin-card { background:var(--surface); border:1.5px solid var(--border); border-radius:28px; padding:2.5rem 2rem 2rem; width:340px; text-align:center; box-shadow:0 40px 100px rgba(0,0,0,.6); animation:popIn .35s cubic-bezier(.34,1.56,.64,1); }
.pin-brand { font-family:'Playfair Display',serif; font-size:2.1rem; font-weight:900; color:var(--accent); margin-bottom:2px; }
.pin-brand span { color:var(--accent2); }
.pin-subtitle { font-size:.72rem; color:var(--text3); letter-spacing:2.5px; text-transform:uppercase; margin-bottom:1.4rem; }
.pin-user-display { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:.5rem; margin-bottom:1rem; font-size:.85rem; font-weight:600; color:var(--text2); }
.pin-label { font-size:.95rem; color:var(--text2); font-weight:500; margin-bottom:1rem; }
.pin-dots { display:flex; gap:14px; justify-content:center; margin-bottom:1.4rem; }
.pin-dot { width:18px; height:18px; border-radius:50%; border:2px solid var(--border2); background:transparent; transition:all .2s; }
.pin-dot.filled { background:var(--accent); border-color:var(--accent); box-shadow:0 0 10px rgba(200,80,26,.5); }
.pin-numpad { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
.pin-key { padding:1rem; border:1.5px solid var(--border); background:var(--surface2); border-radius:14px; font-size:1.2rem; font-weight:600; cursor:pointer; color:var(--text); font-family:'Outfit',sans-serif; transition:all .15s; user-select:none; }
.pin-key:hover  { background:var(--accent); color:#fff; border-color:var(--accent); transform:scale(.95); }
.pin-key:active { transform:scale(.88); }
.pin-key.wide   { grid-column:span 2; }
.pin-key.del-key { color:var(--red); }
.pin-msg { margin-top:1rem; font-size:.85rem; color:var(--red); min-height:1.1rem; }
.pin-switch-btn { margin-top:.8rem; background:none; border:none; color:var(--text3); font-size:.8rem; cursor:pointer; text-decoration:underline; font-family:'Outfit',sans-serif; }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-bg { display:none; position:fixed; inset:0; z-index:9000; background:rgba(10,5,2,.88); backdrop-filter:blur(6px); justify-content:center; align-items:center; }
.modal-bg.show { display:flex; }
.modal { background:var(--surface); border:1.5px solid var(--border); border-radius:24px; padding:2rem; width:min(480px,94vw); box-shadow:0 40px 100px rgba(0,0,0,.55); animation:popIn .3s cubic-bezier(.34,1.56,.64,1); max-height:90vh; overflow-y:auto; }
.modal-title { font-size:1.1rem; font-weight:700; margin-bottom:1.2rem; display:flex; align-items:center; gap:8px; }
.modal-close { margin-left:auto; background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text2); padding:0 4px; transition:color .2s; }
.modal-close:hover { color:var(--red); }

/* ‚îÄ‚îÄ PROFILES ‚îÄ‚îÄ */
.profile-list { display:flex; flex-direction:column; gap:.6rem; max-height:300px; overflow-y:auto; margin-bottom:1rem; }
.profile-item { display:flex; align-items:center; gap:.8rem; padding:.8rem 1rem; border:1.5px solid var(--border); border-radius:14px; cursor:pointer; transition:all .2s; background:var(--surface2); }
.profile-item:hover, .profile-item.active-profile { border-color:var(--accent); background:var(--surface3); }
.profile-avatar { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; font-weight:700; color:#fff; flex-shrink:0; }
.profile-name { font-weight:600; font-size:.95rem; }
.profile-meta { font-size:.75rem; color:var(--text2); }
.profile-del { margin-left:auto; background:var(--red-bg); border:none; color:var(--red); width:28px; height:28px; border-radius:8px; cursor:pointer; font-size:.8rem; display:flex; align-items:center; justify-content:center; transition:all .15s; flex-shrink:0; }
.profile-del:hover { background:var(--red); color:#fff; }
.add-profile-row { display:flex; gap:.6rem; }
.add-profile-row input { flex:1; padding:.7rem 1rem; border:1.5px solid var(--border); border-radius:12px; background:var(--surface2); color:var(--text); font-family:'Outfit',sans-serif; font-size:.9rem; outline:none; }
.add-profile-row input:focus { border-color:var(--accent); }
.add-profile-row button { padding:.7rem 1.2rem; background:var(--accent); color:#fff; border:none; border-radius:12px; cursor:pointer; font-weight:600; font-family:'Outfit',sans-serif; transition:all .2s; white-space:nowrap; }
.add-profile-row button:hover { opacity:.88; }

/* ‚îÄ‚îÄ DATE FILTER ‚îÄ‚îÄ */
.filter-row { display:flex; gap:.8rem; margin-bottom:1rem; }
.filter-row .field { flex:1; }
.quick-filters { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1.2rem; }
.qf-btn { padding:.35rem .85rem; border:1.5px solid var(--border); border-radius:20px; background:var(--surface2); color:var(--text2); font-size:.78rem; font-weight:600; cursor:pointer; font-family:'Outfit',sans-serif; transition:all .15s; }
.qf-btn:hover, .qf-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.filter-active-badge { display:inline-flex; align-items:center; gap:4px; background:var(--accent); color:#fff; border-radius:20px; padding:.2rem .7rem; font-size:.75rem; font-weight:600; margin-left:.5rem; }
.filter-active-badge button { background:none; border:none; color:#fff; cursor:pointer; padding:0; font-size:.85rem; line-height:1; }

/* ‚îÄ‚îÄ INVENTORY ‚îÄ‚îÄ */
.inv-list { display:flex; flex-direction:column; gap:.6rem; max-height:340px; overflow-y:auto; margin-bottom:1rem; }
.inv-item { display:flex; align-items:center; gap:.8rem; padding:.8rem 1rem; border:1.5px solid var(--border); border-radius:14px; background:var(--surface2); }
.inv-item-info { flex:1; }
.inv-item-name { font-weight:600; font-size:.95rem; }
.inv-item-meta { font-size:.75rem; color:var(--text2); margin-top:2px; }
.inv-stock-badge { padding:.2rem .7rem; border-radius:20px; font-size:.75rem; font-weight:700; white-space:nowrap; }
.inv-stock-badge.ok  { background:var(--green-bg); color:var(--green); }
.inv-stock-badge.low { background:#fff3e0; color:#e07000; }
.inv-stock-badge.out { background:var(--red-bg); color:var(--red); }
[data-theme="dark"] .inv-stock-badge.low { background:#2a1800; color:#e09030; }
.inv-item-actions { display:flex; gap:.4rem; }
.inv-adj-btn { width:28px; height:28px; border-radius:8px; border:1.5px solid var(--border); background:var(--surface); cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; color:var(--text); transition:all .15s; }
.inv-adj-btn:hover { background:var(--accent); color:#fff; border-color:var(--accent); }
.inv-del-btn { width:28px; height:28px; border-radius:8px; background:var(--red-bg); border:none; color:var(--red); cursor:pointer; font-size:.8rem; display:flex; align-items:center; justify-content:center; transition:all .15s; }
.inv-del-btn:hover { background:var(--red); color:#fff; }
.add-inv-form { display:grid; grid-template-columns:1fr 1fr auto; gap:.6rem; align-items:end; }
.add-inv-form .field { margin:0; }
.add-inv-form button { padding:.78rem 1rem; background:var(--green); color:#fff; border:none; border-radius:12px; cursor:pointer; font-weight:600; font-family:'Outfit',sans-serif; white-space:nowrap; transition:all .15s; }
.add-inv-form button:hover { opacity:.88; }
.low-stock-alert { display:flex; align-items:center; gap:.5rem; background:#fff3e0; border:1.5px solid #f0a000; border-radius:10px; padding:.6rem .9rem; font-size:.8rem; font-weight:600; color:#a06000; margin-bottom:.8rem; }
[data-theme="dark"] .low-stock-alert { background:#2a1800; border-color:#8a6000; color:#e09030; }

/* ‚îÄ‚îÄ CLOUD BACKUP ‚îÄ‚îÄ */
.cloud-section { margin-bottom:1.4rem; }
.cloud-section h3 { font-size:.85rem; font-weight:700; color:var(--text2); letter-spacing:1px; text-transform:uppercase; margin-bottom:.8rem; }
.cloud-btn { width:100%; padding:.85rem; border-radius:14px; font-family:'Outfit',sans-serif; font-weight:700; font-size:.95rem; cursor:pointer; border:none; transition:all .2s; margin-bottom:.5rem; display:flex; align-items:center; justify-content:center; gap:.6rem; }
.cloud-btn.export-json { background:linear-gradient(135deg,var(--blue),#2a8ada); color:#fff; box-shadow:0 4px 16px rgba(26,106,176,.3); }
.cloud-btn.export-json:hover { transform:translateY(-2px); }
.cloud-btn.export-csv  { background:linear-gradient(135deg,var(--green),#38c070); color:#fff; box-shadow:0 4px 16px rgba(30,122,69,.3); }
.cloud-btn.export-csv:hover  { transform:translateY(-2px); }
.cloud-btn.import-all  { background:var(--surface2); color:var(--text); border:1.5px solid var(--border); }
.cloud-btn.import-all:hover  { border-color:var(--accent2); color:var(--accent2); }
.cloud-btn.reset-all   { background:var(--red-bg); color:var(--red); border:1.5px solid rgba(176,32,32,.2); }
.cloud-btn.reset-all:hover   { background:var(--red); color:#fff; }
.cloud-info { font-size:.78rem; color:var(--text3); text-align:center; margin-top:.4rem; }
.backup-timestamp { font-size:.78rem; color:var(--text2); background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:.5rem .8rem; text-align:center; margin-bottom:.8rem; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header { position:sticky; top:0; z-index:200; background:var(--surface); border-bottom:1.5px solid var(--border); padding:.75rem 1.4rem; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 30px var(--shadow2); transition:background .4s; }
.logo { font-family:'Playfair Display',serif; font-size:1.75rem; font-weight:900; color:var(--accent); line-height:1; letter-spacing:-.5px; }
.logo span { color:var(--accent2); }
.tagline { font-size:.68rem; color:var(--text3); letter-spacing:2.5px; text-transform:uppercase; margin-top:3px; font-weight:500; }
.header-right { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
.date-pill { background:var(--surface2); border:1px solid var(--border); border-radius:30px; padding:.3rem .9rem; font-size:.75rem; color:var(--text2); font-weight:600; }
.hdr-btn { padding:.38rem .8rem; border-radius:30px; border:1.5px solid var(--border); background:var(--surface2); color:var(--text2); font-size:.75rem; cursor:pointer; font-family:'Outfit',sans-serif; font-weight:500; transition:all .2s; }
.hdr-btn:hover { border-color:var(--accent); color:var(--accent); background:var(--surface3); }
.hdr-btn.profile-btn { display:flex; align-items:center; gap:.4rem; }
.hdr-avatar { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.7rem; font-weight:700; color:#fff; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast { position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(20px); padding:.8rem 1.5rem; border-radius:50px; font-size:.9rem; font-weight:600; opacity:0; pointer-events:none; transition:all .3s; z-index:9998; white-space:nowrap; box-shadow:0 8px 30px rgba(0,0,0,.25); }
#toast.show    { opacity:1; transform:translateX(-50%) translateY(0); }
#toast.success { background:var(--green); color:#fff; }
#toast.error   { background:var(--red);   color:#fff; }
#toast.info    { background:var(--blue);  color:#fff; }
#toast:not(.success):not(.error):not(.info) { background:#222; color:#fff; }

/* ‚îÄ‚îÄ INSTALL BANNER ‚îÄ‚îÄ */
#installBanner { position:fixed; bottom:1rem; left:50%; transform:translateX(-50%); background:var(--surface); border:1.5px solid var(--accent); border-radius:20px; padding:.9rem 1.4rem; box-shadow:0 10px 40px var(--shadow2); z-index:500; display:flex; align-items:center; gap:.8rem; animation:slideUp .4s ease; max-width:90vw; }
#installBanner.hidden { display:none !important; }
.install-text { font-size:.85rem; font-weight:600; }
.install-text span { color:var(--text2); font-weight:400; font-size:.78rem; display:block; }
.install-yes { background:var(--accent); color:#fff; border:none; border-radius:10px; padding:.5rem 1.1rem; font-family:'Outfit',sans-serif; font-weight:700; cursor:pointer; font-size:.85rem; transition:all .2s; white-space:nowrap; }
.install-yes:hover { opacity:.88; }
.install-no { background:none; border:none; color:var(--text3); cursor:pointer; font-size:1.2rem; padding:0 4px; }

/* ‚îÄ‚îÄ CONTAINER ‚îÄ‚îÄ */
.container { max-width:1020px; margin:0 auto; padding:1.8rem 1.4rem 5rem; position:relative; z-index:1; }

/* ‚îÄ‚îÄ SUMMARY CARDS ‚îÄ‚îÄ */
.summary-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; margin-bottom:1.6rem; }
.stat-card { background:var(--surface); border:1.5px solid var(--border); border-radius:22px; padding:1.4rem 1.4rem 1.2rem; position:relative; overflow:hidden; box-shadow:0 4px 24px var(--shadow); transition:transform .2s,box-shadow .2s; animation:slideUp .5s ease both; }
.stat-card:hover { transform:translateY(-4px); box-shadow:0 12px 36px var(--shadow2); }
.stat-card:nth-child(1){ animation-delay:.05s; }
.stat-card:nth-child(2){ animation-delay:.12s; }
.stat-card:nth-child(3){ animation-delay:.19s; }
.stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; border-radius:22px 22px 0 0; }
.stat-card.sales::before   { background:linear-gradient(90deg,#1e7a45,#38c070); }
.stat-card.expense::before { background:linear-gradient(90deg,#b02020,#d45050); }
.stat-card.profit::before  { background:linear-gradient(90deg,var(--accent),var(--accent2)); }
.stat-card::after { content:''; position:absolute; bottom:-25px; right:-25px; width:100px; height:100px; border-radius:50%; opacity:.07; }
.stat-card.sales::after   { background:var(--green); }
.stat-card.expense::after { background:var(--red); }
.stat-card.profit::after  { background:var(--accent); }
.stat-icon  { font-size:1.6rem; margin-bottom:.6rem; display:block; }
.stat-label { font-size:.72rem; font-weight:600; color:var(--text2); letter-spacing:1.8px; text-transform:uppercase; margin-bottom:.35rem; }
.stat-value { font-size:2rem; font-weight:700; line-height:1; font-family:'Playfair Display',serif; }
.stat-card.sales .stat-value   { color:var(--green); }
.stat-card.expense .stat-value { color:var(--red); }
.stat-card.profit .stat-value  { color:var(--accent); }
.profit-tag { display:inline-block; margin-top:.6rem; padding:.22rem .75rem; border-radius:30px; font-size:.75rem; font-weight:600; }
.profit-tag.pos  { background:var(--green-bg); color:var(--green); }
.profit-tag.neg  { background:var(--red-bg);   color:var(--red); }
.profit-tag.even { background:var(--surface3);  color:var(--text2); }

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs { display:flex; gap:.5rem; margin-bottom:1.4rem; background:var(--surface2); padding:6px; border-radius:18px; border:1.5px solid var(--border); flex-wrap:wrap; }
.tab-btn { flex:1; padding:.62rem .4rem; border:none; border-radius:13px; background:transparent; color:var(--text2); font-family:'Outfit',sans-serif; font-size:.82rem; font-weight:600; cursor:pointer; transition:all .2s; white-space:nowrap; min-width:60px; }
.tab-btn:hover  { color:var(--text); }
.tab-btn.active { background:var(--surface); color:var(--accent); box-shadow:0 2px 14px var(--shadow2); }

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel        { display:none; }
.panel.active { display:block; animation:slideUp .3s ease; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card { background:var(--surface); border:1.5px solid var(--border); border-radius:22px; padding:1.5rem; margin-bottom:1.2rem; box-shadow:0 4px 20px var(--shadow); }
.card-title { font-size:1rem; font-weight:700; color:var(--text); margin-bottom:1.2rem; display:flex; align-items:center; gap:9px; }
.card-title-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.sale-dot { background:var(--green); box-shadow:0 0 6px rgba(30,122,69,.5); }
.exp-dot  { background:var(--red);   box-shadow:0 0 6px rgba(176,32,32,.5); }
.field { margin-bottom:1rem; }
.field label { display:block; font-size:.75rem; font-weight:700; color:var(--text2); letter-spacing:1px; margin-bottom:.4rem; text-transform:uppercase; }
.field input, .field select { width:100%; padding:.8rem 1rem; border:1.5px solid var(--border); border-radius:13px; background:var(--surface2); color:var(--text); font-family:'Outfit',sans-serif; font-size:.97rem; font-weight:500; outline:none; transition:border .2s,box-shadow .2s; }
.field input::placeholder { color:var(--text3); }
.field input:focus, .field select:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(200,80,26,.12); background:var(--surface); }
.field select { cursor:pointer; }
.row        { display:flex; gap:.8rem; }
.row .field { flex:1; }
.btn { width:100%; padding:.95rem; border:none; border-radius:14px; font-family:'Outfit',sans-serif; font-size:1rem; font-weight:700; cursor:pointer; letter-spacing:.3px; transition:all .2s; }
.btn-sale { background:linear-gradient(135deg,var(--green) 0%,#38c070 100%); color:#fff; box-shadow:0 6px 22px rgba(30,122,69,.3); }
.btn-sale:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(30,122,69,.4); }
.btn-exp  { background:linear-gradient(135deg,var(--red) 0%,#d45050 100%); color:#fff; box-shadow:0 6px 22px rgba(176,32,32,.3); }
.btn-exp:hover  { transform:translateY(-2px); box-shadow:0 10px 30px rgba(176,32,32,.4); }

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
.history-toolbar { display:flex; gap:.6rem; margin-bottom:1.2rem; flex-wrap:wrap; align-items:center; }
.search-wrap { position:relative; flex:1; min-width:180px; }
.search-icon { position:absolute; left:1rem; top:50%; transform:translateY(-50%); font-size:1rem; pointer-events:none; }
.search-wrap input { width:100%; padding:.78rem 1rem .78rem 2.8rem; border:1.5px solid var(--border); border-radius:14px; background:var(--surface); color:var(--text); font-family:'Outfit',sans-serif; font-size:.95rem; outline:none; transition:border .2s,box-shadow .2s; }
.search-wrap input::placeholder { color:var(--text3); }
.search-wrap input:focus { border-color:var(--accent2); box-shadow:0 0 0 3px rgba(232,154,32,.12); }
.filter-btn { padding:.72rem 1rem; border:1.5px solid var(--border); border-radius:14px; background:var(--surface); color:var(--text2); font-family:'Outfit',sans-serif; font-size:.85rem; font-weight:600; cursor:pointer; transition:all .2s; white-space:nowrap; display:flex; align-items:center; gap:.4rem; }
.filter-btn:hover      { border-color:var(--accent2); color:var(--accent2); }
.filter-btn.has-filter { border-color:var(--accent); color:var(--accent); background:var(--surface3); }
.list-header  { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
.list-title   { font-size:1rem; font-weight:700; }
.list-actions { display:flex; gap:.5rem; }
.export-btn, .clear-btn { padding:.35rem .9rem; border-radius:8px; font-size:.78rem; font-weight:600; cursor:pointer; font-family:'Outfit',sans-serif; transition:all .15s; }
.export-btn { background:var(--surface2); color:var(--text2); border:1.5px solid var(--border); }
.export-btn:hover { border-color:var(--accent2); color:var(--accent2); }
.clear-btn  { background:var(--red-bg); color:var(--red); border:1.5px solid rgba(176,32,32,.2); }
.clear-btn:hover  { background:var(--red); color:#fff; }
ul { list-style:none; padding:0; margin:0; }
li { display:flex; justify-content:space-between; align-items:center; padding:.85rem .6rem; border-bottom:1px solid var(--border); transition:background .15s; border-radius:10px; animation:slideUp .25s ease; }
li:hover      { background:var(--surface2); }
li:last-child { border-bottom:none; }
.item-info   { flex:1; min-width:0; }
.item-name   { font-weight:600; font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.item-meta   { font-size:.78rem; color:var(--text2); margin-top:2px; }
.item-date   { font-size:.72rem; color:var(--text3); margin-top:2px; }
.item-amount { font-weight:700; font-size:1rem; font-family:'Playfair Display',serif; margin:0 .8rem; white-space:nowrap; }
.item-amount.green { color:var(--green); }
.item-amount.red   { color:var(--red); }
.del-btn { width:30px; height:30px; border-radius:8px; background:var(--red-bg); color:var(--red); border:1px solid rgba(176,32,32,.2); font-size:.75rem; cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center; transition:all .15s; }
.del-btn:hover { background:var(--red); color:#fff; transform:scale(1.1); }
.empty      { text-align:center; padding:2.5rem 0; color:var(--text3); font-size:.9rem; }
.empty-icon { font-size:2.2rem; margin-bottom:.5rem; }

/* ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ */
.report-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
.chart-card canvas { max-height:260px; }

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
footer { text-align:center; padding-top:2rem; font-size:.78rem; color:var(--text3); letter-spacing:.5px; }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:640px) {
  .summary-grid { grid-template-columns:1fr; }
  .report-row   { grid-template-columns:1fr; }
}
@media(max-width:500px) {
  header     { padding:.6rem 1rem; }
  .logo      { font-size:1.4rem; }
  .date-pill { display:none; }
  .container { padding:1.2rem .9rem 4rem; }
}
  </style>
</head>
<body>

  <!-- PIN OVERLAY -->
  <div id="pinOverlay" class="show">
    <div class="pin-card">
      <div class="pin-brand">Sika<span>Track</span></div>
      <div class="pin-subtitle">Money Made Simple</div>
      <div class="pin-user-display" id="pinUserDisplay" style="display:none"></div>
      <div class="pin-label" id="pinLabel">Enter your 4-digit PIN</div>
      <div class="pin-dots">
        <div class="pin-dot" id="d0"></div>
        <div class="pin-dot" id="d1"></div>
        <div class="pin-dot" id="d2"></div>
        <div class="pin-dot" id="d3"></div>
      </div>
      <div class="pin-numpad">
        <button class="pin-key" onclick="pinPress('1')">1</button>
        <button class="pin-key" onclick="pinPress('2')">2</button>
        <button class="pin-key" onclick="pinPress('3')">3</button>
        <button class="pin-key" onclick="pinPress('4')">4</button>
        <button class="pin-key" onclick="pinPress('5')">5</button>
        <button class="pin-key" onclick="pinPress('6')">6</button>
        <button class="pin-key" onclick="pinPress('7')">7</button>
        <button class="pin-key" onclick="pinPress('8')">8</button>
        <button class="pin-key" onclick="pinPress('9')">9</button>
        <button class="pin-key wide" onclick="pinPress('0')">0</button>
        <button class="pin-key del-key" onclick="pinDel()">‚å´</button>
      </div>
      <div class="pin-msg" id="pinMsg"></div>
      <button class="pin-switch-btn" onclick="openProfileFromPin()">Switch Profile</button>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="modal-bg" id="profileModal">
    <div class="modal">
      <div class="modal-title">üë• Profiles <button class="modal-close" onclick="closeModal('profileModal')">‚úï</button></div>
      <div class="profile-list" id="profileList"></div>
      <div class="add-profile-row">
        <input type="text" id="newProfileName" placeholder="New profile name‚Ä¶" maxlength="24">
        <button onclick="createProfile()">Ôºã Add</button>
      </div>
    </div>
  </div>

  <!-- DATE FILTER MODAL -->
  <div class="modal-bg" id="dateFilterModal">
    <div class="modal">
      <div class="modal-title">üìÖ Filter by Date <button class="modal-close" onclick="closeModal('dateFilterModal')">‚úï</button></div>
      <div class="quick-filters">
        <button class="qf-btn" onclick="setQuickFilter('today',event)">Today</button>
        <button class="qf-btn" onclick="setQuickFilter('week',event)">This Week</button>
        <button class="qf-btn" onclick="setQuickFilter('month',event)">This Month</button>
        <button class="qf-btn" onclick="setQuickFilter('last30',event)">Last 30 Days</button>
        <button class="qf-btn" onclick="setQuickFilter('all',event)">All Time</button>
      </div>
      <div class="filter-row">
        <div class="field"><label>From Date</label><input type="date" id="filterFrom"></div>
        <div class="field"><label>To Date</label><input type="date" id="filterTo"></div>
      </div>
      <button class="btn btn-sale" style="width:100%;margin-top:.5rem" onclick="applyDateFilter()">Apply Filter</button>
    </div>
  </div>

  <!-- INVENTORY MODAL -->
  <div class="modal-bg" id="inventoryModal">
    <div class="modal">
      <div class="modal-title">üì¶ Inventory <button class="modal-close" onclick="closeModal('inventoryModal')">‚úï</button></div>
      <div id="lowStockAlert" class="low-stock-alert" style="display:none">‚ö†Ô∏è Some items are low or out of stock!</div>
      <div class="inv-list" id="invList"></div>
      <div class="add-inv-form">
        <div class="field"><label>Item Name</label><input type="text" id="invName" placeholder="e.g. Tomatoes"></div>
        <div class="field"><label>Stock Qty</label><input type="number" id="invQty" min="0" placeholder="e.g. 50"></div>
        <button onclick="addInventoryItem()">Ôºã Add</button>
      </div>
    </div>
  </div>

  <!-- CLOUD MODAL -->
  <div class="modal-bg" id="cloudModal">
    <div class="modal">
      <div class="modal-title">‚òÅÔ∏è Backup &amp; Restore <button class="modal-close" onclick="closeModal('cloudModal')">‚úï</button></div>
      <div class="cloud-section">
        <h3>Last Backup</h3>
        <div class="backup-timestamp" id="backupTimestamp">No backup yet</div>
      </div>
      <div class="cloud-section">
        <h3>Export</h3>
        <button class="cloud-btn export-json" onclick="exportAllData()">üì§ Export All Data (JSON)</button>
        <button class="cloud-btn export-csv"  onclick="exportCSVAll()">üìä Export All as CSV</button>
        <div class="cloud-info">Save to Google Drive, WhatsApp or email to yourself</div>
      </div>
      <div class="cloud-section">
        <h3>Restore</h3>
        <label class="cloud-btn import-all" style="cursor:pointer">
          üì• Import from JSON File
          <input type="file" accept=".json" onchange="importData(event)" style="display:none">
        </label>
        <div class="cloud-info">Select a previously exported SikaTrack JSON file</div>
      </div>
      <div class="cloud-section">
        <h3>Danger Zone</h3>
        <button class="cloud-btn reset-all" onclick="resetAllData()">üóëÔ∏è Wipe All Data</button>
      </div>
    </div>
  </div>

  <!-- INSTALL BANNER -->
  <div id="installBanner" class="hidden">
    <div><div class="install-text">üì± Install SikaTrack <span>Add to home screen ‚Äî works offline!</span></div></div>
    <button class="install-yes" id="installBtn">Install</button>
    <button class="install-no" onclick="dismissInstall()">‚úï</button>
  </div>

  <!-- HEADER -->
  <header>
    <div>
      <div class="logo">Sika<span>Track</span></div>
      <div class="tagline">Money Made Simple</div>
    </div>
    <div class="header-right">
      <div class="date-pill" id="datePill"></div>
      <button class="hdr-btn profile-btn" onclick="openModal('profileModal');renderProfiles()">
        <span class="hdr-avatar" id="headerAvatar" style="background:#c8501a">?</span>
        <span id="headerProfileName">Profile</span>
      </button>
      <button class="hdr-btn" onclick="openModal('inventoryModal');renderInventory()">üì¶</button>
      <button class="hdr-btn" onclick="openModal('cloudModal');renderBackupInfo()">‚òÅÔ∏è</button>
      <button class="hdr-btn" onclick="toggleLang()">üá¨üá≠ <span id="langLabel">Twi</span></button>
      <button class="hdr-btn" onclick="toggleTheme()"><span id="themeIcon">üåô</span></button>
    </div>
  </header>

  <div id="toast"></div>

  <div class="container">

    <!-- SUMMARY -->
    <div class="summary-grid">
      <div class="stat-card sales">
        <span class="stat-icon">üìà</span>
        <div class="stat-label" data-en="Total Sales" data-tw="Nk…îden Nyinaa">Total Sales</div>
        <div class="stat-value">‚Çµ<span id="totalSales">0.00</span></div>
      </div>
      <div class="stat-card expense">
        <span class="stat-icon">üìâ</span>
        <div class="stat-label" data-en="Total Expenses" data-tw="Sika a W…îde K…î">Total Expenses</div>
        <div class="stat-value">‚Çµ<span id="totalExpenses">0.00</span></div>
      </div>
      <div class="stat-card profit">
        <span class="stat-icon">üí∞</span>
        <div class="stat-label" data-en="Net Profit" data-tw="Fafiri Sika">Net Profit</div>
        <div class="stat-value">‚Çµ<span id="netProfit">0.00</span></div>
        <span class="profit-tag even" id="profitTag">Break Even</span>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('sales',event)">üí∞ Sale</button>
      <button class="tab-btn"        onclick="switchTab('expenses',event)">üßæ Expense</button>
      <button class="tab-btn"        onclick="switchTab('history',event)">üìã History</button>
      <button class="tab-btn"        onclick="switchTab('reports',event)">üìä Reports</button>
    </div>

    <!-- PANEL: SALES -->
    <div class="panel active" id="panel-sales">
      <div class="card">
        <div class="card-title"><span class="card-title-dot sale-dot"></span>Record a Sale</div>
        <div class="field">
          <label for="product">What did you sell?</label>
          <input type="text" id="product" placeholder="e.g. Tomatoes, Fabric, Chargers" list="invSuggestions">
          <datalist id="invSuggestions"></datalist>
        </div>
        <div class="row">
          <div class="field"><label for="quantity">Quantity</label><input type="number" id="quantity" min="0" placeholder="e.g. 5"></div>
          <div class="field"><label for="price">Price per Item (‚Çµ)</label><input type="number" id="price" min="0" step="0.01" placeholder="e.g. 12.50"></div>
        </div>
        <button class="btn btn-sale" onclick="addSale()">‚úÖ Save Sale</button>
      </div>
    </div>

    <!-- PANEL: EXPENSES -->
    <div class="panel" id="panel-expenses">
      <div class="card">
        <div class="card-title"><span class="card-title-dot exp-dot"></span>Record an Expense</div>
        <div class="field"><label for="expenseName">What did you spend on?</label><input type="text" id="expenseName" placeholder="e.g. Transport, Rent, Supplies"></div>
        <div class="field"><label for="expenseAmount">Amount (‚Çµ)</label><input type="number" id="expenseAmount" min="0" step="0.01" placeholder="e.g. 50.00"></div>
        <button class="btn btn-exp" onclick="addExpense()">‚úÖ Save Expense</button>
      </div>
    </div>

    <!-- PANEL: HISTORY -->
    <div class="panel" id="panel-history">
      <div class="history-toolbar">
        <div class="search-wrap">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchInput" placeholder="Search‚Ä¶" oninput="applySearch()">
        </div>
        <button class="filter-btn" id="filterBtn" onclick="openModal('dateFilterModal')">
          üìÖ Filter <span id="filterBadge"></span>
        </button>
      </div>
      <div class="card">
        <div class="list-header">
          <div class="list-title">üí∞ Sales</div>
          <div class="list-actions">
            <button class="export-btn" onclick="exportCSV('sales')">‚¨á Export</button>
            <button class="clear-btn"  onclick="clearAll('sales')">Clear</button>
          </div>
        </div>
        <ul id="salesList"></ul>
      </div>
      <div class="card">
        <div class="list-header">
          <div class="list-title">üßæ Expenses</div>
          <div class="list-actions">
            <button class="export-btn" onclick="exportCSV('expenses')">‚¨á Export</button>
            <button class="clear-btn"  onclick="clearAll('expenses')">Clear</button>
          </div>
        </div>
        <ul id="expenseList"></ul>
      </div>
    </div>

    <!-- PANEL: REPORTS -->
    <div class="panel" id="panel-reports">
      <div class="report-row">
        <div class="card chart-card"><div class="card-title">üìä Sales vs Expenses</div><canvas id="reportChart"></canvas></div>
        <div class="card chart-card"><div class="card-title">ü•ß Breakdown</div><canvas id="pieChart"></canvas></div>
      </div>
    </div>

    <footer>üîí Your data stays on your device &nbsp;¬∑&nbsp; Built for Ghana üá¨üá≠ &nbsp;¬∑&nbsp; SikaTrack v2</footer>

  </div>

  <script>
/* ============================================================
   SikaTrack v2 ‚Äî Full Script
   ============================================================ */

const AVATAR_COLORS = ['#c8501a','#1e7a45','#1a6ab0','#8b2fc9','#c8960a','#b02020','#2a7a8a'];

let profiles        = JSON.parse(localStorage.getItem('st_profiles')) || [];
let activeProfileId = localStorage.getItem('st_activeProfile') || null;
let currentTheme    = localStorage.getItem('st_theme') || 'light';
let currentLang     = localStorage.getItem('st_lang')  || 'en';
let searchQuery     = '';
let filterFrom      = null;
let filterTo        = null;
let pinBuffer       = '';
let pinMode         = 'unlock';
window._barChart    = null;
window._pieChart    = null;
let deferredPrompt  = null;

/* ‚îÄ‚îÄ PROFILE HELPERS ‚îÄ‚îÄ */
function getProfile(id)   { return profiles.find(p => p.id === id); }
function saveProfiles()   { localStorage.setItem('st_profiles', JSON.stringify(profiles)); }
function currentProfile() { return getProfile(activeProfileId) || profiles[0] || null; }
function profileData(id, key)      { return JSON.parse(localStorage.getItem(`st_${id}_${key}`)) || []; }
function saveProfileData(id,key,v) { localStorage.setItem(`st_${id}_${key}`, JSON.stringify(v)); }
function getSales()       { const p=currentProfile(); return p ? profileData(p.id,'sales')     : []; }
function getExpenses()    { const p=currentProfile(); return p ? profileData(p.id,'expenses')  : []; }
function getInventory()   { const p=currentProfile(); return p ? profileData(p.id,'inventory') : []; }
function saveSales(d)     { const p=currentProfile(); if(p) saveProfileData(p.id,'sales',d);     }
function saveExpenses(d)  { const p=currentProfile(); if(p) saveProfileData(p.id,'expenses',d);  }
function saveInventory(d) { const p=currentProfile(); if(p) saveProfileData(p.id,'inventory',d); }

function createProfile() {
  const name = document.getElementById('newProfileName').value.trim();
  if (!name) return showToast('Enter a profile name','error');
  if (profiles.find(p => p.name.toLowerCase()===name.toLowerCase())) return showToast('Profile already exists','error');
  const id=`p_${Date.now()}`, color=AVATAR_COLORS[profiles.length%AVATAR_COLORS.length];
  profiles.push({id,name,color,pin:''});
  saveProfiles();
  document.getElementById('newProfileName').value='';
  renderProfiles();
  showToast(`‚úÖ Profile "${name}" created`,'success');
}

function switchProfile(id) {
  activeProfileId=id; localStorage.setItem('st_activeProfile',id);
  closeModal('profileModal'); updateHeaderProfile(); refreshAll();
  const p=getProfile(id);
  if (p&&p.pin) showPinForProfile(p);
  else showToast(`Switched to ${p?.name||'profile'}`,'info');
}

function deleteProfile(id) {
  if (profiles.length<=1) return showToast('Cannot delete the only profile','error');
  if (!confirm('Delete this profile and all its data?')) return;
  ['sales','expenses','inventory'].forEach(k=>localStorage.removeItem(`st_${id}_${k}`));
  profiles=profiles.filter(p=>p.id!==id); saveProfiles();
  if (activeProfileId===id) { activeProfileId=profiles[0].id; localStorage.setItem('st_activeProfile',activeProfileId); }
  renderProfiles(); updateHeaderProfile(); refreshAll();
}

function renderProfiles() {
  const list=document.getElementById('profileList'); if(!list) return;
  if (!profiles.length) { list.innerHTML='<div class="empty">No profiles yet</div>'; return; }
  list.innerHTML=profiles.map(p=>`
    <div class="profile-item ${p.id===activeProfileId?'active-profile':''}" onclick="switchProfile('${p.id}')">
      <div class="profile-avatar" style="background:${p.color}">${p.name[0].toUpperCase()}</div>
      <div>
        <div class="profile-name">${p.name}</div>
        <div class="profile-meta">${profileData(p.id,'sales').length} sales ¬∑ ${profileData(p.id,'expenses').length} expenses</div>
      </div>
      <button class="profile-del" onclick="event.stopPropagation();deleteProfile('${p.id}')">‚úï</button>
    </div>`).join('');
}

function updateHeaderProfile() {
  const p=currentProfile(), av=document.getElementById('headerAvatar'), nm=document.getElementById('headerProfileName');
  if (!p) return;
  if (av) { av.style.background=p.color; av.textContent=p.name[0].toUpperCase(); }
  if (nm) nm.textContent=p.name;
}

/* ‚îÄ‚îÄ PIN ‚îÄ‚îÄ */
function updateDots() {
  for (let i=0;i<4;i++) document.getElementById('d'+i).classList.toggle('filled',i<pinBuffer.length);
}
function pinPress(ch) {
  if (pinBuffer.length>=4) return;
  pinBuffer+=ch; updateDots();
  if (pinBuffer.length===4) setTimeout(submitPIN,200);
}
function pinDel() {
  pinBuffer=pinBuffer.slice(0,-1); updateDots();
  document.getElementById('pinMsg').textContent='';
}
function submitPIN() {
  const p=currentProfile(); if(!p) return;
  if (pinMode==='set') {
    p.pin=pinBuffer; saveProfiles();
    document.getElementById('pinOverlay').classList.remove('show');
    showToast('‚úÖ PIN saved','success');
  } else {
    if (!p.pin||pinBuffer===p.pin) { document.getElementById('pinOverlay').classList.remove('show'); }
    else { document.getElementById('pinMsg').textContent='‚ùå Wrong PIN. Try again.'; pinBuffer=''; updateDots(); }
  }
}
function showPinForProfile(p) {
  pinBuffer=''; updateDots();
  const lbl=document.getElementById('pinLabel'), ud=document.getElementById('pinUserDisplay');
  if (lbl) lbl.textContent=p.pin?'Enter your PIN':'Set a new 4-digit PIN';
  if (ud)  { ud.style.display='block'; ud.textContent='üë§ '+p.name; }
  pinMode=p.pin?'unlock':'set';
  document.getElementById('pinOverlay').classList.add('show');
}
function openProfileFromPin() {
  document.getElementById('pinOverlay').classList.remove('show');
  openModal('profileModal'); renderProfiles();
}

/* ‚îÄ‚îÄ DATE FILTER ‚îÄ‚îÄ */
function setQuickFilter(type,e) {
  const now=new Date(), today=now.toISOString().slice(0,10);
  let from, to=today;
  if      (type==='today')  { from=today; }
  else if (type==='week')   { const d=new Date(now); d.setDate(d.getDate()-d.getDay()); from=d.toISOString().slice(0,10); }
  else if (type==='month')  { from=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`; }
  else if (type==='last30') { const d=new Date(now); d.setDate(d.getDate()-30); from=d.toISOString().slice(0,10); }
  else {
    filterFrom=null; filterTo=null;
    document.querySelectorAll('.qf-btn').forEach(b=>b.classList.remove('active'));
    if(e?.target) e.target.classList.add('active');
    updateFilterUI(); closeModal('dateFilterModal'); return;
  }
  document.getElementById('filterFrom').value=from;
  document.getElementById('filterTo').value=to;
  filterFrom=from; filterTo=to;
  document.querySelectorAll('.qf-btn').forEach(b=>b.classList.remove('active'));
  if(e?.target) e.target.classList.add('active');
  updateFilterUI(); closeModal('dateFilterModal');
}
function applyDateFilter() {
  filterFrom=document.getElementById('filterFrom').value||null;
  filterTo  =document.getElementById('filterTo').value  ||null;
  updateFilterUI(); closeModal('dateFilterModal');
}
function updateFilterUI() {
  const btn=document.getElementById('filterBtn'), badge=document.getElementById('filterBadge');
  if (filterFrom||filterTo) {
    btn?.classList.add('has-filter');
    if(badge) badge.innerHTML=`<span class="filter-active-badge">${filterFrom||'‚Ä¶'} ‚Üí ${filterTo||'‚Ä¶'} <button onclick="clearFilter()">‚úï</button></span>`;
  } else {
    btn?.classList.remove('has-filter');
    if(badge) badge.innerHTML='';
  }
  renderSales(); renderExpenses(); updateSummary();
}
function clearFilter() { filterFrom=null; filterTo=null; updateFilterUI(); }
function inDateRange(ts) {
  if (!filterFrom&&!filterTo) return true;
  const d=new Date(ts).toISOString().slice(0,10);
  if (filterFrom&&d<filterFrom) return false;
  if (filterTo  &&d>filterTo)   return false;
  return true;
}

/* ‚îÄ‚îÄ INVENTORY ‚îÄ‚îÄ */
function addInventoryItem() {
  const name=document.getElementById('invName').value.trim();
  const qty =parseInt(document.getElementById('invQty').value);
  if (!name)            return showToast('Enter item name','error');
  if (isNaN(qty)||qty<0) return showToast('Enter valid quantity','error');
  const inv=getInventory();
  if (inv.find(i=>i.name.toLowerCase()===name.toLowerCase())) return showToast('Item already in inventory','error');
  inv.push({id:`i_${Date.now()}`,name,qty,lowThreshold:5});
  saveInventory(inv);
  document.getElementById('invName').value=''; document.getElementById('invQty').value='';
  renderInventory(); updateInvSuggestions();
  showToast(`üì¶ ${name} added to inventory`,'success');
}
function adjustInv(id,delta) {
  const inv=getInventory(), item=inv.find(i=>i.id===id); if(!item) return;
  item.qty=Math.max(0,item.qty+delta); saveInventory(inv); renderInventory();
}
function deleteInvItem(id) {
  saveInventory(getInventory().filter(i=>i.id!==id)); renderInventory(); updateInvSuggestions();
}
function renderInventory() {
  const list=document.getElementById('invList'), alert=document.getElementById('lowStockAlert');
  if(!list) return;
  const inv=getInventory(), hasLow=inv.some(i=>i.qty<=i.lowThreshold);
  if(alert) alert.style.display=hasLow?'flex':'none';
  if(!inv.length){ list.innerHTML='<div class="empty"><div class="empty-icon">üì¶</div>No inventory yet.</div>'; return; }
  list.innerHTML=inv.map(i=>{
    const cls=i.qty===0?'out':i.qty<=i.lowThreshold?'low':'ok';
    const lbl=i.qty===0?'Out of Stock':i.qty<=i.lowThreshold?`Low: ${i.qty}`:`In Stock: ${i.qty}`;
    return `<div class="inv-item">
      <div class="inv-item-info"><div class="inv-item-name">${i.name}</div><div class="inv-item-meta">Low alert at ‚â§ ${i.lowThreshold}</div></div>
      <span class="inv-stock-badge ${cls}">${lbl}</span>
      <div class="inv-item-actions">
        <button class="inv-adj-btn" onclick="adjustInv('${i.id}',1)">Ôºã</button>
        <button class="inv-adj-btn" onclick="adjustInv('${i.id}',-1)">‚àí</button>
        <button class="inv-del-btn" onclick="deleteInvItem('${i.id}')">‚úï</button>
      </div>
    </div>`;
  }).join('');
}
function updateInvSuggestions() {
  const dl=document.getElementById('invSuggestions'); if(!dl) return;
  dl.innerHTML=getInventory().map(i=>`<option value="${i.name}">`).join('');
}

/* ‚îÄ‚îÄ BACKUP / RESTORE ‚îÄ‚îÄ */
function exportAllData() {
  const p=currentProfile(); if(!p) return;
  const payload={exportedAt:new Date().toISOString(),profile:p.name,sales:getSales(),expenses:getExpenses(),inventory:getInventory()};
  triggerDownload(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}),`sikatrack_${p.name}_${Date.now()}.json`);
  localStorage.setItem('st_lastBackup',new Date().toISOString()); renderBackupInfo();
  showToast('üì§ Data exported!','success');
}
function exportCSVAll() {
  const p=currentProfile(); if(!p) return;
  const header='Type,Name,Qty,Price,Total,Amount,Date';
  const sRows=getSales().map(r=>`SALE,"${r.name}",${r.qty},${r.price},${r.total},,${fmtDate(r.date)}`);
  const eRows=getExpenses().map(r=>`EXPENSE,"${r.name}",,,,${r.amount},${fmtDate(r.date)}`);
  triggerDownload(new Blob([[header,...sRows,...eRows].join('\n')],{type:'text/csv'}),`sikatrack_${p.name}_all_${Date.now()}.csv`);
  showToast('üìä CSV exported!','success');
}
function importData(event) {
  const file=event.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try {
      const data=JSON.parse(e.target.result);
      if(!data.sales&&!data.expenses) throw new Error('Invalid');
      if(!confirm(`Import data from "${data.profile||'unknown'}"?\nThis will REPLACE current profile data.`)) return;
      if(data.sales)     saveSales(data.sales);
      if(data.expenses)  saveExpenses(data.expenses);
      if(data.inventory) saveInventory(data.inventory);
      localStorage.setItem('st_lastBackup',new Date().toISOString());
      refreshAll(); closeModal('cloudModal');
      showToast('üì• Data imported!','success');
    } catch { showToast('Invalid or corrupted file','error'); }
  };
  reader.readAsText(file);
}
function resetAllData() {
  if(!confirm('‚ö†Ô∏è Wipe ALL data for this profile?\nThis cannot be undone.')) return;
  saveSales([]); saveExpenses([]); saveInventory([]);
  refreshAll(); closeModal('cloudModal');
  showToast('üóëÔ∏è All data cleared','info');
}
function renderBackupInfo() {
  const ts=document.getElementById('backupTimestamp'), last=localStorage.getItem('st_lastBackup');
  if(ts) ts.textContent=last?`Last backup: ${fmtDate(new Date(last).getTime())}`:'No backup yet';
}
function triggerDownload(blob,filename) {
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
}

/* ‚îÄ‚îÄ THEME & LANG ‚îÄ‚îÄ */
function applyTheme(t) {
  currentTheme=t; document.documentElement.setAttribute('data-theme',t);
  const icon=document.getElementById('themeIcon'); if(icon) icon.textContent=t==='dark'?'‚òÄÔ∏è':'üåô';
  localStorage.setItem('st_theme',t); if(window._barChart) rebuildCharts();
}
function toggleTheme() { applyTheme(currentTheme==='dark'?'light':'dark'); }
function applyLang(lang) {
  currentLang=lang; localStorage.setItem('st_lang',lang);
  document.querySelectorAll('[data-en]').forEach(el=>{ el.textContent=el.getAttribute('data-'+lang)||el.getAttribute('data-en'); });
  const lbl=document.getElementById('langLabel'); if(lbl) lbl.textContent=lang==='en'?'Twi':'English';
  const si=document.getElementById('searchInput'); if(si) si.placeholder=lang==='tw'?'Hwehw…õ nk…îden anaa sika‚Ä¶':'Search‚Ä¶';
  renderSales(); renderExpenses(); updateSummary();
}
function toggleLang() { applyLang(currentLang==='en'?'tw':'en'); }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
function openModal(id)  { document.getElementById(id)?.classList.add('show'); }
function closeModal(id) { document.getElementById(id)?.classList.remove('show'); }

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
function switchTab(tab,e) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('panel-'+tab)?.classList.add('active');
  if(e?.target) e.target.classList.add('active');
  if(tab==='reports') setTimeout(rebuildCharts,80);
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
function showToast(msg,type='') {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show '+type;
  clearTimeout(t._tid); t._tid=setTimeout(()=>{t.className='';},2800);
}

/* ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ */
const fmt     = n  => Number(n).toFixed(2);
const fmtDate = ts => new Date(ts).toLocaleDateString('en-GH',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});

/* ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ */
function updateSummary() {
  const sales=getSales().filter(s=>inDateRange(s.date));
  const expenses=getExpenses().filter(e=>inDateRange(e.date));
  const ts=sales.reduce((a,s)=>a+s.total,0);
  const te=expenses.reduce((a,e)=>a+e.amount,0);
  const np=ts-te;
  document.getElementById('totalSales').textContent    =fmt(ts);
  document.getElementById('totalExpenses').textContent =fmt(te);
  document.getElementById('netProfit').textContent     =fmt(Math.abs(np));
  const tag=document.getElementById('profitTag'); if(!tag) return;
  if      (np>0){ tag.textContent='üü¢ Profit';    tag.className='profit-tag pos'; }
  else if (np<0){ tag.textContent='üî¥ Loss';       tag.className='profit-tag neg'; }
  else          { tag.textContent='‚öñÔ∏è Break Even'; tag.className='profit-tag even'; }
}

/* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
function applySearch() {
  searchQuery=(document.getElementById('searchInput')?.value||'').toLowerCase().trim();
  renderSales(); renderExpenses();
}

/* ‚îÄ‚îÄ RENDER SALES ‚îÄ‚îÄ */
function renderSales() {
  const ul=document.getElementById('salesList'); if(!ul) return;
  let data=[...getSales()].reverse().map((s,i)=>({...s,ri:getSales().length-1-i})).filter(s=>inDateRange(s.date));
  if(searchQuery) data=data.filter(s=>s.name.toLowerCase().includes(searchQuery));
  if(!data.length){ ul.innerHTML=`<div class="empty"><div class="empty-icon">üõí</div>${searchQuery?'No results.':(currentLang==='tw'?'Nk…îden biara nni h…î.':'No sales yet.')}</div>`; return; }
  ul.innerHTML=data.map(s=>`
    <li>
      <div class="item-info">
        <div class="item-name">${s.name}</div>
        <div class="item-meta">${s.qty} √ó ‚Çµ${fmt(s.price)}</div>
        <div class="item-date">üïê ${fmtDate(s.date)}</div>
      </div>
      <span class="item-amount green">‚Çµ${fmt(s.total)}</span>
      <button class="del-btn" onclick="deleteSale(${s.ri})">‚úï</button>
    </li>`).join('');
}

/* ‚îÄ‚îÄ RENDER EXPENSES ‚îÄ‚îÄ */
function renderExpenses() {
  const ul=document.getElementById('expenseList'); if(!ul) return;
  let data=[...getExpenses()].reverse().map((e,i)=>({...e,ri:getExpenses().length-1-i})).filter(e=>inDateRange(e.date));
  if(searchQuery) data=data.filter(e=>e.name.toLowerCase().includes(searchQuery));
  if(!data.length){ ul.innerHTML=`<div class="empty"><div class="empty-icon">üßæ</div>${searchQuery?'No results.':(currentLang==='tw'?'Sika biara nni h…î.':'No expenses yet.')}</div>`; return; }
  ul.innerHTML=data.map(e=>`
    <li>
      <div class="item-info">
        <div class="item-name">${e.name}</div>
        <div class="item-date">üïê ${fmtDate(e.date)}</div>
      </div>
      <span class="item-amount red">‚Çµ${fmt(e.amount)}</span>
      <button class="del-btn" onclick="deleteExpense(${e.ri})">‚úï</button>
    </li>`).join('');
}

/* ‚îÄ‚îÄ ADD SALE ‚îÄ‚îÄ */
function addSale() {
  const name =document.getElementById('product')?.value.trim();
  const qty  =parseFloat(document.getElementById('quantity')?.value);
  const price=parseFloat(document.getElementById('price')?.value);
  if(!name)           return showToast('‚ö†Ô∏è Enter a product name','error');
  if(!qty||qty<=0)    return showToast('‚ö†Ô∏è Enter a valid quantity','error');
  if(!price||price<=0) return showToast('‚ö†Ô∏è Enter a valid price','error');
  const sales=getSales(); sales.push({name,qty,price,total:qty*price,date:Date.now()}); saveSales(sales);
  const inv=getInventory(), item=inv.find(i=>i.name.toLowerCase()===name.toLowerCase());
  if(item){ item.qty=Math.max(0,item.qty-qty); saveInventory(inv); }
  document.getElementById('product').value=''; document.getElementById('quantity').value=''; document.getElementById('price').value='';
  refreshAll(); showToast(`‚úÖ Sale saved ‚Äî ‚Çµ${fmt(qty*price)}`,'success');
}

/* ‚îÄ‚îÄ ADD EXPENSE ‚îÄ‚îÄ */
function addExpense() {
  const name  =document.getElementById('expenseName')?.value.trim();
  const amount=parseFloat(document.getElementById('expenseAmount')?.value);
  if(!name)            return showToast('‚ö†Ô∏è Enter an expense name','error');
  if(!amount||amount<=0) return showToast('‚ö†Ô∏è Enter a valid amount','error');
  const expenses=getExpenses(); expenses.push({name,amount,date:Date.now()}); saveExpenses(expenses);
  document.getElementById('expenseName').value=''; document.getElementById('expenseAmount').value='';
  refreshAll(); showToast(`‚úÖ Expense saved ‚Äî ‚Çµ${fmt(amount)}`,'success');
}

/* ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ */
function deleteSale(i)    { const s=getSales();    s.splice(i,1); saveSales(s);    refreshAll(); }
function deleteExpense(i) { const e=getExpenses(); e.splice(i,1); saveExpenses(e); refreshAll(); }

/* ‚îÄ‚îÄ CLEAR ALL ‚îÄ‚îÄ */
function clearAll(type) {
  if(!confirm(`Clear all ${type}? This cannot be undone.`)) return;
  if(type==='sales')    saveSales([]);
  if(type==='expenses') saveExpenses([]);
  refreshAll();
}

/* ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ */
function exportCSV(type) {
  const data=type==='sales'?getSales():getExpenses();
  if(!data.length) return showToast('Nothing to export','error');
  const header=type==='sales'?'Name,Qty,Price,Total,Date':'Name,Amount,Date';
  const rows=data.map(r=>type==='sales'?`"${r.name}",${r.qty},${r.price},${r.total},${fmtDate(r.date)}`:`"${r.name}",${r.amount},${fmtDate(r.date)}`);
  triggerDownload(new Blob([header+'\n'+rows.join('\n')],{type:'text/csv'}),`sikatrack_${type}_${Date.now()}.csv`);
}

/* ‚îÄ‚îÄ REFRESH ALL ‚îÄ‚îÄ */
function refreshAll() { renderSales(); renderExpenses(); updateSummary(); updateInvSuggestions(); }

/* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
function getCSSVar(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
function rebuildCharts() {
  const isDark=currentTheme==='dark', gridColor=isDark?'rgba(255,255,255,0.06)':'rgba(0,0,0,0.06)', textColor=getCSSVar('--text2');
  const sales=getSales().filter(s=>inDateRange(s.date)), expenses=getExpenses().filter(e=>inDateRange(e.date));
  const ts=sales.reduce((a,s)=>a+s.total,0), te=expenses.reduce((a,e)=>a+e.amount,0), np=Math.max(0,ts-te);
  const barCtx=document.getElementById('reportChart')?.getContext('2d');
  if(barCtx){ if(window._barChart) window._barChart.destroy();
    window._barChart=new Chart(barCtx,{type:'bar',data:{labels:['Sales','Expenses'],datasets:[{data:[ts,te],backgroundColor:['rgba(30,122,69,.82)','rgba(176,32,32,.82)'],borderRadius:10,borderSkipped:false}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{color:gridColor},ticks:{color:textColor}},y:{grid:{color:gridColor},ticks:{color:textColor,callback:v=>'‚Çµ'+v}}}}});
  }
  const pieCtx=document.getElementById('pieChart')?.getContext('2d');
  if(pieCtx){ if(window._pieChart) window._pieChart.destroy();
    window._pieChart=new Chart(pieCtx,{type:'doughnut',data:{labels:['Sales','Expenses','Profit'],datasets:[{data:[ts,te,np],backgroundColor:['rgba(30,122,69,.85)','rgba(176,32,32,.85)','rgba(200,80,26,.85)'],borderWidth:2,borderColor:isDark?'#261808':'#fff',hoverOffset:8}]},options:{responsive:true,cutout:'60%',plugins:{legend:{labels:{color:textColor,font:{family:'Outfit'}}}}}});
  }
}

/* ‚îÄ‚îÄ PWA ‚îÄ‚îÄ */
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault(); deferredPrompt=e;
  if(!localStorage.getItem('st_installDismissed')){ const b=document.getElementById('installBanner'); if(b) b.classList.remove('hidden'); }
});
document.getElementById('installBtn')?.addEventListener('click',async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const{outcome}=await deferredPrompt.userChoice;
  deferredPrompt=null; document.getElementById('installBanner').classList.add('hidden');
  if(outcome==='accepted') showToast('üì± SikaTrack installed!','success');
});
function dismissInstall(){ document.getElementById('installBanner').classList.add('hidden'); localStorage.setItem('st_installDismissed','1'); }

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded',()=>{
  if(!profiles.length){
    const id='p_default', name='My Shop';
    profiles=[{id,name,color:AVATAR_COLORS[0],pin:''}]; saveProfiles();
    const oldS=localStorage.getItem('st_sales'), oldE=localStorage.getItem('st_expenses');
    if(oldS) saveProfileData(id,'sales',JSON.parse(oldS));
    if(oldE) saveProfileData(id,'expenses',JSON.parse(oldE));
  }
  if(!activeProfileId||!getProfile(activeProfileId)){
    activeProfileId=profiles[0].id; localStorage.setItem('st_activeProfile',activeProfileId);
  }
  applyTheme(currentTheme); applyLang(currentLang);
  const dp=document.getElementById('datePill');
  if(dp) dp.textContent=new Date().toLocaleDateString('en-GH',{weekday:'short',day:'numeric',month:'short'});
  updateHeaderProfile(); refreshAll();
  const p=currentProfile(); if(p) showPinForProfile(p);
  document.querySelectorAll('.modal-bg').forEach(bg=>{ bg.addEventListener('click',e=>{ if(e.target===bg) bg.classList.remove('show'); }); });
  ['product','quantity','price'].forEach(id=>{ document.getElementById(id)?.addEventListener('keydown',e=>{ if(e.key==='Enter') addSale(); }); });
  ['expenseName','expenseAmount'].forEach(id=>{ document.getElementById(id)?.addEventListener('keydown',e=>{ if(e.key==='Enter') addExpense(); }); });
});
  </script>
</body>
</html>
